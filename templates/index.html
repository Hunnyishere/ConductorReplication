<!DOCTYPE html>
<html>
<head>
    <title>My Conductor</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src='https://kit.fontawesome.com/a076d05399.js'></script>
    <script type="text/javascript" src="static/js/data.js"></script>
</head>
<body>

    <div class="jumbotron text-center">
        <h1>Conductor</h1>
        <p></p> 
    </div>

<div class="container">
    <div class="row">
        <div class="col-xs-6">
            <div id="planning">

            </div>
        </div>

        <div class="col-xs-6">
			<form id="add_effect_form" action="" method="post">
                <h3>Add Effect</h3>
				<div class="form-group">
				  <label for="add_effect_name">Effect</label>
				  <input type="text" class="form-control" id="add_effect_name" placeholder="">
				</div>
				<div class="form-group">
				  <label for="add_effect_endpoint_select">Endpoint</label>
				  <select class="form-control" id="add_effect_endpoint_select"></select>
				</div>
			</form>
			<button type="button" class="btn btn-primary" id="add_effect_button">Add Effect</button>


            <form id="edit_precondition_form" action="" method="post">
                <h3>Edit Precondition</h3>
                <div class="form-group" id="edit_precondition_checkbox_layout"></div>
            </form>


            <form id="add_action_form" action="" method="post">
                <h3>Add Action</h3>
				<div class="form-group">
				  <label for="add_action_name">Action Name</label>
				  <input type="text" class="form-control" id="add_action_name" placeholder="New Action">
				</div>
                <div class="form-group">
				  <label for="add_action_position_select">After action:</label>
				  <select class="form-control" id="add_action_position_select"></select>
				</div>
				<div class="form-group" id="add_action_checkbox_layout"></div>
			</form>
			<button type="button" class="btn btn-primary" id="add_action_button">Add Action</button>
        </div>
    </div>
</div>


<script>
	$(document).ready(function(){
	    // 这几个list要随改随更新！！
        action_list = {{ action_list|tojson }};
        action_dict = {{ action_dict|tojson }};
        precondition_list = {{ precondition_list|tojson }};
        precondition_dict = {{ precondition_dict|tojson }};
        effect_list = {{ effect_list|tojson }};
        
        // every effect is a new color
		color_set = ['gold','orange','red','palevioletred','purple','green','gray','black']
        color_idx = 0;

		// load initial plan
		createPlanning();

        // global variables
        edit_action = "";
        delete_action = "";
        // click edit icon: add effect/edit precondition
        clickEditIcon();
        // click delete icon:
        clickDeleteIcon();

        // submit add effect
        var add_effect_button = document.getElementById("add_effect_button");
        add_effect_button.addEventListener('click', function() { 
            submitAddEffect();
        }); 

        // add action panel: position select onchange -> load precondition checkbox
        var add_action_select = document.getElementById("add_action_position_select");
        add_action_select.addEventListener('change', function() { 
            loadAddActionCheckbox();
        }); 
        // submit add action
        var add_action_button = document.getElementById("add_action_button");
        add_action_button.onclick = submitAddAction;
	})






    // --------Define functions below-------------

    function clickEditIcon(){
        var array = Array.from(document.getElementsByClassName('edit_btn'));
        array.forEach(btn=>{
            btn.onclick = e=>{
                //console.log(e);
                // click on pen
                if(e.target.getAttribute("class")=="fa fa-pen")
                    edit_action = e.target.parentElement.parentElement.id;
                // click on outside rectangle button
                else
                    edit_action = e.target.parentElement.id;
                editAction();

                // update edit precondition: precondition checkbox onchange -> change planning graph
                updateEditPrecondition();
            }
        });
    }

    function clickDeleteIcon(){
        var array = Array.from(document.getElementsByClassName('delete_btn'));
        array.forEach(btn=>{
            btn.onclick = e=>{
                //console.log(e);
                // click on pen
                if(e.target.getAttribute("class")=="fa fa-trash")
                    delete_action = e.target.parentElement.parentElement.id;
                // click on outside rectangle button
                else
                    delete_action = e.target.parentElement.id;
                deleteAction();
            }
        });
    }

    function updateEditPrecondition(){
        var pre_chx_array = Array.from(document.getElementsByClassName('edit_precondition_checkbox'));
        pre_chx_array.forEach(chx=>{
            chx.onchange = e=>{
                var pre = e.target.getAttribute("value");
                var checked = e.target.checked;  //change to unchecked: false, checked: true
                updatePreconditionInGraph(pre, checked);
            }
        });
    }

    // edit precondition
    // update precondition for particular action in graph
    function updatePreconditionInGraph(pre, checked){
        // index of current action in action_list
        var current_idx = action_list.indexOf(edit_action);

        // add this precondition to this action
        if(checked){
            console.log("----add precondition----")
            // if already has this precondition
            if(pre in precondition_dict){ // judge existence: dict: item in dict, list: list.includes(item)
                // update data
                // update precondition_dict
                precondition_dict[pre].push(edit_action);
                // sort by index in action_list
                precondition_dict[pre].sort(function(a, b){return action_list.indexOf(a)-action_list.indexOf(b)});
                // update action_dict
                action_dict[edit_action]["Precondition"].push(pre);
                // sort by index in precondition_list
                action_dict[edit_action]["Precondition"].sort(function(a, b){return precondition_list.indexOf(a)-precondition_list.indexOf(b)});


                // update the graph
                var idx_in_pre = precondition_dict[pre].indexOf(edit_action);
                // 
                if(idx_in_pre==0){
                    console.log("is the only one in pre");
                    var pre_start_action = effect_list[pre];
                    var previous_idx_in_pre = action_list.indexOf(pre_start_action);
                }   
                else
                {
                    console.log("not the only one in pre");
                    var previous_action_in_pre = precondition_dict[pre][idx_in_pre-1];
                    var previous_idx_in_pre = action_list.indexOf(previous_action_in_pre);
                }  
                for(var i=previous_idx_in_pre; i<=current_idx-1; i++){
                    console.log(i);
                    var svg = document.getElementById(action_list[i]+"_"+pre+"_svg");
                    var children = svg.childNodes;  // link+cap
                    // show link
                    children[0].setAttribute('visibility', 'visible');
                    if(i==current_idx-1){
                        // show cap
                        children[1].setAttribute('visibility', 'visible');
                    }
                }
            }
            // if precondition is newly created
            else{
                // update precondition_dict
                //precondition_dict[pre] = [edit_action];

            }
        }
        // delete this precondition to this action
        else{
            console.log("----delete precondition----")
            // not the last action that needs this precondition
            if(precondition_dict[pre].indexOf(edit_action) != precondition_dict[pre].length-1){
                console.log("not last one");
                // this action's precondition link is in previous action's link row
                var previous_action = action_list[current_idx-1];
                var previous_svg = document.getElementById(previous_action+"_"+pre+"_svg");
                var previous_children = previous_svg.childNodes;  // link+cap

                // hide cap
                previous_children[1].setAttribute('visibility', 'hidden');
            }
            // is the last action that needs this precondition
            else{
                console.log("is the last one");
                // hide link and cap in this action, and hide previous links until the penultimate action in precondition_dict
                var idx_in_pre = precondition_dict[pre].indexOf(edit_action);
                // if is the only one
                if(idx_in_pre==0){
                    console.log("it's the only one");
                    for(var i=0;i<current_idx;i++){
                        var svg = document.getElementById(action_list[i]+"_"+pre+"_svg");
                        svg.setAttribute('visibility', 'hidden');
                        svg.childNodes[0].setAttribute('visibility', 'hidden');
                        svg.childNodes[1].setAttribute('visibility', 'hidden');
                    }
                }
                // if not the only one
                else{
                    console.log("it's not the only one");
                    var penultimate_idx = action_list.indexOf(precondition_dict[pre][idx_in_pre-1]);
                    console.log(penultimate_idx);
                    for(var i=penultimate_idx; i<current_idx; i++){
                        var svg = document.getElementById(action_list[i]+"_"+pre+"_svg");
                        svg.setAttribute('visibility', 'hidden');
                        svg.childNodes[0].setAttribute('visibility', 'hidden');
                        svg.childNodes[1].setAttribute('visibility', 'hidden');
                    }
                }
            }
            // update data
            // update precondition_dict
            precondition_dict[pre] = precondition_dict[pre].filter(function(e) { return e !== edit_action });
            // update action_dict
            action_dict[edit_action]["Precondition"] = action_dict[edit_action]["Precondition"].filter(function(e) { return e !== pre });
        }
    }

    function editAction(){
        console.log("editAction");

        // add precondition checkbox
        var checkbox_layout = document.getElementById("edit_precondition_checkbox_layout");
        // remove all childNodes before add new ones
        while(checkbox_layout.childNodes.length!=0)
            checkbox_layout.removeChild(checkbox_layout.childNodes[0]);
        // add new
        var last_pre_idx = -1;
        for(var i=action_list.indexOf(edit_action)-1; i>=0; i--){
            if(action_dict[action_list[i]]["Effect"].length>0){
                var pre = action_dict[action_list[i]]["Effect"][action_dict[action_list[i]]["Effect"].length-1];
                last_pre_idx = precondition_list.indexOf(pre);
                break;
            }
        }
        for(var pre_idx in precondition_list){
            if(pre_idx>last_pre_idx)
                break;
            var pre = precondition_list[pre_idx];
            var pre_checkbox = document.createElement("input");
            pre_checkbox.setAttribute("type","checkbox");
            pre_checkbox.setAttribute("class","edit_precondition_checkbox");
            pre_checkbox.setAttribute("id",pre+"_checkbox");
            pre_checkbox.setAttribute("value",pre);
            if(precondition_dict[pre].includes(edit_action))
                pre_checkbox.setAttribute("checked","checked");
            var pre_label = document.createElement("label");
            pre_label.setAttribute("for",pre+"_checkbox");
            pre_label.setAttribute("class","checkbox_label");
            var label_text = document.createTextNode(pre);
            pre_label.appendChild(label_text);
            checkbox_layout.appendChild(pre_checkbox);
            checkbox_layout.appendChild(pre_label);
        }

        var endpoint_select = document.getElementById("add_effect_endpoint_select");
        // add endpoint select
        // remove all childNodes before add new ones
        while(endpoint_select.childNodes.length!=0)
            endpoint_select.removeChild(endpoint_select.childNodes[0]);
        // add new
        var edit_act_idx = action_list.indexOf(edit_action);
        for(var i=edit_act_idx+1; i<action_list.length; i++){
            var end_action = action_list[i];
            var option = document.createElement("option");
            option.text = end_action;
            option.value = end_action;
            endpoint_select.appendChild(option);
        }
    }

    function deleteAction(){
        console.log("deleteAction");
        console.log(delete_action);
        // delete action and precondition link in graph
        var action_row = document.getElementById(delete_action+"_action_row");
        action_row.parentNode.removeChild(action_row);
        var current_idx = action_list.indexOf(delete_action);
        if(current_idx != 0){
            var previous_action = action_list[current_idx-1];
            var previous_link_row = document.getElementById(previous_action+"_link_row");
            previous_link_row.parentNode.removeChild(previous_link_row);
        }
        // hide previous links that satisfies preconditions of this action
        for(var pre_idx in action_dict[delete_action]["Precondition"]){
            var pre = action_dict[delete_action]["Precondition"][pre_idx];
            var del_idx_in_pre = precondition_dict[pre].indexOf(delete_action);
            if(del_idx_in_pre==0)
            {
                if(pre in effect_list)
                    var start_action = effect_list[pre];
                else
                    continue;
                var start_idx = action_list.indexOf(start_action);
                var last_idx_in_pre = start_idx;
            }
            else{
                var last_action_in_pre = precondition_dict[pre][del_idx_in_pre-1];
                var last_idx_in_pre = action_list.indexOf(last_action_in_pre);
            }
            for(var i=last_idx_in_pre; i<current_idx-1; i++){
                var svg = document.getElementById(action_list[i]+"_"+pre+"_svg");
                svg.childNodes[0].setAttribute("visibility","hidden");
            }
        }
        
        // deal with following open conditions caused by remove effect from deleted action
        for(eff_idx in action_dict[delete_action]["Effect"]){
            var effect = action_dict[delete_action]["Effect"][eff_idx];
            var last_action = precondition_dict[effect][precondition_dict[effect].length-1];
            var last_idx = action_list.indexOf(last_action);
            for(var i=current_idx;i<last_idx;i++){
                var svg = document.getElementById(action_list[i]+"_"+effect+"_svg");
                if(svg != null){
                    var link = svg.childNodes[0];
                    link.setAttribute('visibility', 'hidden');
                    var cap = svg.childNodes[1];
                    if(precondition_dict[effect].includes(action_list[i+1]))
                        cap.setAttributeNS(null, "fill", "red");
                }
            }
        }

        // set previous link row to current
        if(current_idx != 0){
            var current_link_row = document.getElementById(delete_action+"_link_row");
            current_link_row.setAttribute("id",previous_action+"_link_row");
            var svgs = current_link_row.childNodes;
            for(var i=0; i<svgs.length; i++){
                var svg = svgs[i];
                var current_svg_id = svg.id;
                var previous_svg_id = current_svg_id.substring(delete_action.length,current_svg_id.length-1);
                svg.setAttribute('id', previous_action+previous_svg_id);
            }
        }

        // update data
        // update precondition_dict
        for(var pre_idx in action_dict[delete_action]["Precondition"]){
            var pre = action_dict[delete_action]["Precondition"][pre_idx];
            precondition_dict[pre] = precondition_dict[pre].filter(function(e) { return e !== delete_action });
        }
        // update effect_list
        for(var eff_idx in action_dict[delete_action]["Effect"]){
            var effect = action_dict[delete_action]["Effect"][eff_idx];
            delete effect_list[effect];
        }
        // update action_list
        action_list = action_list.filter(function(e) { return e !== delete_action });
        // update action_dict
        delete action_dict[delete_action];
    }

	function submitAddEffect(){
        console.log("AddEffect");
        var effect = $("#add_effect_name").val();
        var endpoint = $("#add_effect_endpoint_select  option:selected").text();
        var start_idx = action_list.indexOf(edit_action);
        var end_idx = action_list.indexOf(endpoint);
        for(var i=0; i<action_list.length; i++){
            var new_svg = createSvg(action_list[i], effect, hide=false);
            if(i>=start_idx && i<end_idx){
                var new_link = createLink(color_set[color_idx], hide=false);
            }  
            else
                var new_link = createLink(color_set[color_idx], hide=true);
            
            if(i==end_idx-1)
                var new_cap = createCap(hide=false);
            else
                var new_cap = createCap(hide=true);
            new_svg.appendChild(new_link);
            new_svg.appendChild(new_cap);
            // add svg to document
			var link_row = document.getElementById(action_list[i]+"_link_row");
            link_row.append(new_svg);
        }
        
        // update data
        color_idx++;
        // update effect_list
        effect_list[effect] = edit_action;
        // update action_dict
        action_dict[edit_action]["Effect"].push(effect);
        // sort by index in precondition_list
        action_dict[edit_action]["Effect"].sort(function(a, b){return precondition_list.indexOf(a)-precondition_list.indexOf(b)});
        // update precondition_list: insert at position start_idx
        // if this is the first action that has effect
        var insert_idx = 0;
        // if this action and previous actions have effects
        for(var i=start_idx; i>=0; i--){
            if(action_dict[action_list[i]]["Effect"].length==0)
                continue;
            else{
                var last_eff = action_dict[action_list[i]]["Effect"][action_dict[action_list[i]]["Effect"].length-1];
                var last_eff_idx = precondition_list.indexOf(last_eff);
                insert_idx = last_eff_idx+1;
                break;
            }
        }
        precondition_list.splice(insert_idx, 0, effect);
        // update precondition_dict
        precondition_dict[effect] = [endpoint];
    }

	function submitAddAction(){
        console.log("AddAction");
        var new_action = $('#add_action_name').val();
        // create rows for action and link
        [row_action_div, row_link_div] = createRows(new_action);
        // add to frame
        var planning_frame = document.getElementById("planning");
        // insert after user-defined position
        var previous_action = $("#add_action_position_select option:selected").text();
        var previous_idx = action_list.indexOf(previous_action);

        // deep copy previous link row to new action
        var previous_link_row = document.getElementById(action_list[previous_idx]+"_link_row");
        var previous_pres = [];
        for(var i=0; i<previous_link_row.childNodes.length; i++){
            var previous_svg = previous_link_row.childNodes[i];
            // get preconditon name
            var previous_svg_id = previous_svg.id;
            var pre = previous_svg_id.substring(previous_action.length+1,previous_svg_id.length-4);
            // create link and cap with the same setting as previous_svg
            var previous_link = previous_svg.childNodes[0];
            var link_color = previous_link.getAttribute("fill");
            var previous_cap = previous_svg.childNodes[1];
            var previous_cap_visibility = previous_cap.getAttribute("visibility");
            if(previous_cap_visibility=="visible")
                previous_pres.push(pre);
            var new_svg = createSvg(new_action, pre);
			var new_link = createLink(link_color, hide=(previous_link.getAttribute("visibility")=="hidden"));
			new_svg.appendChild(new_link);
			var new_cap = createCap(hide=(previous_cap_visibility=="hidden"));
			new_svg.appendChild(new_cap);
            row_link_div.appendChild(new_svg);
            // if the set previous_svg cap to hidden
            previous_svg.childNodes[1].setAttribute("visibility","hidden");
        }
        
        // insert after the last action
        if(previous_idx == (action_list.length-1)){
            planning_frame.appendChild(row_action_div);
            planning_frame.appendChild(row_link_div);
        }
        // insert before the next action
        else{
            var next_action_row = document.getElementById(action_list[previous_idx+1]+"_action_row");
            planning_frame.insertBefore(row_link_div, next_action_row);
            planning_frame.insertBefore(row_action_div, row_link_div);
        }

        // update data
        // update action_list
        action_list.splice(previous_idx+1, 0, new_action); //insert item into arr at the specified index (deleting 0 items first, that is, it's just an insert)
        // update action_dict
        action_dict[new_action] = {"Precondition":[],"Effect":[]};


        $('.add_action_checkbox:checked').each(function(i){
            var pre = $(this).val();
            //console.log(pre);

            // update data
            // update precondition_dict
            precondition_dict[pre].push(new_action);
            // sort by index in action_list
            precondition_dict[pre].sort(function(a, b){return action_list.indexOf(a)-action_list.indexOf(b)});
            // update action_dict
            action_dict[new_action]["Precondition"].push(pre);
            // sort by index in precondition_list
            action_dict[new_action]["Precondition"].sort(function(a, b){return precondition_list.indexOf(a)-precondition_list.indexOf(b)});
            

            // next action has this precondition, already have link, set cap to visible
            if(previous_pres.includes(pre)){
                var svg = document.getElementById(previous_action+"_"+pre+"_svg");
                svg.childNodes[1].setAttribute("visibility","visible");
            }
            // if next action doesn't have this precondition, create from last action in pre_dict
            else{
                var new_idx_in_pre = precondition_dict[pre].indexOf(new_action);
                // not the last one in precondition_dict[pre], add cap
                if(new_idx_in_pre < precondition_dict[pre].length-1){
                    var svg = document.getElementById(previous_action+"_"+pre+"_svg");
                    svg.childNodes[1].setAttribute("visibility","visible");
                }
                // is the last one in precondition_dict[pre]
                else{
                    if(new_idx_in_pre==0)
                        var last_idx_in_pre = 0;
                    else{
                        var last_action_in_pre = precondition_dict[pre][new_idx_in_pre-1];
                        var last_idx_in_pre = action_list.indexOf(last_action_in_pre);
                    }
                    for(var i=last_idx_in_pre; i<=action_list.indexOf(new_action)-1; i++){
                        var svg = document.getElementById(action_list[i]+"_"+pre+"_svg");
                        svg.childNodes[0].setAttribute("visibility","visible");
                        if(i==action_list.indexOf(new_action)-1)
                            svg.childNodes[1].setAttribute("visibility","visible");
                    }
                }
            } 
        });
	}

    function loadAddActionCheckbox(){
        var after_action = $("#add_action_position_select option:selected").text();
        // add precondition checkbox
        var checkbox_layout = document.getElementById("add_action_checkbox_layout");
        // remove all childNodes before add new ones
        while(checkbox_layout.childNodes.length!=0)
            checkbox_layout.removeChild(checkbox_layout.childNodes[0]);
        // add new
        var pre_last_idx = action_list.indexOf(after_action);
        // preconditions can only be out of effects from previous actions
        for(var i=0; i<=pre_last_idx; i++){
            for(var eff_idx in action_dict[action_list[i]]["Effect"]){
                var effect = action_dict[action_list[i]]["Effect"][eff_idx];
                var pre_checkbox = document.createElement("input");
                pre_checkbox.setAttribute("type","checkbox");
                pre_checkbox.setAttribute("class","add_action_checkbox");
                pre_checkbox.setAttribute("id",effect+"_checkbox");
                pre_checkbox.setAttribute("value",effect);
                var pre_label = document.createElement("label");
                pre_label.setAttribute("for",effect+"_checkbox");
                pre_label.setAttribute("class","checkbox_label");
                var label_text = document.createTextNode(effect);
                pre_label.appendChild(label_text);
                checkbox_layout.appendChild(pre_checkbox);
                checkbox_layout.appendChild(pre_label);
            }  
        }
    }




    // initial setting functions
	function createSvg(action, pre){
		// create new svg object
		var new_svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
		new_svg.setAttribute('id', action+"_"+pre+"_svg");
		new_svg.setAttribute('width', '4%');
		new_svg.setAttribute('height', '40');
		new_svg.setAttribute('version', '1.1');
		new_svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
		new_svg.setAttribute('vertical-align', 'top');
		return new_svg;
	}

	function createCap(hide){
		var new_cap = document.createElementNS("http://www.w3.org/2000/svg", "path");
		new_cap.setAttributeNS(null, "id", "new_cap");
		new_cap.setAttributeNS(null, "d", "M15,40 a1,1 0 1,0 -15,0");
		new_cap.setAttributeNS(null, "fill", "dodgerblue");
		if(hide)
            new_cap.setAttribute('visibility', 'hidden');
        else
            new_cap.setAttribute('visibility', 'visible');
		return new_cap;
	}

	function createLink(color, hide){
		var new_link = document.createElementNS("http://www.w3.org/2000/svg", "rect");
		new_link.setAttributeNS(null, "id", "new_link");
		new_link.setAttributeNS(null, "x", "2.5");
		new_link.setAttributeNS(null, "y", "0");
		new_link.setAttributeNS(null, "width", "10");
		new_link.setAttributeNS(null, "height", "40");
        new_link.setAttributeNS(null, "fill", color);
        if(hide)
            new_link.setAttribute('visibility', 'hidden');
        else
            new_link.setAttribute('visibility', 'visible');
		return new_link;
	}

	function createIcons(action){
	    //<button class="btn"><i class="fa fa-trash"></i></button>
	    //<i class='fas fa-pen'></i>
	    var delete_button = document.createElement("button");
		delete_button.setAttribute("class","delete_btn");
		delete_button.setAttribute("id",action+"_delete_button");
		delete_button.setAttribute("padding","0px 0px");
		delete_button.setAttribute("border","none");
		var delete_icon = document.createElement("i");
		delete_icon.setAttribute("class","fa fa-trash");
		delete_button.appendChild(delete_icon);

		var edit_button = document.createElement("button");
		edit_button.setAttribute("class","edit_btn");
		edit_button.setAttribute("id",action+"_edit_button");
		var edit_icon = document.createElement("i");
		edit_icon.setAttribute("class","fa fa-pen");
		edit_button.appendChild(edit_icon);

		return [delete_button, edit_button];
	}

	function loadAddActionSelect(){
	    var select = document.getElementById("add_action_position_select");
	    for(var act_idx in action_list){
	        if(act_idx==action_list.length-1) break;
            var action = action_list[act_idx];
            var option = document.createElement("option");
            option.text = action;
            option.value = action;
            select.appendChild(option);
	    }
    }
    
    function createRows(action){
        // create rows
        // action rows
        var row_action_div = document.createElement("div");
        row_action_div.setAttribute("class","row");
        row_action_div.setAttribute("id",action+"_action_row");
        // link rows
        var row_link_div = document.createElement("div");
        row_link_div.setAttribute("class","row");
        row_link_div.setAttribute("id",action+"_link_row");

        // add action
        var action_div = document.createElement("div");
        action_div.setAttribute("class","action");
        action_div.setAttribute("id",action);
        // text within div
        var action_text = document.createElement("font");
        action_text.setAttribute("class","actionText");
        action_text.textContent = action
        action_div.appendChild(action_text);
        // create icon buttons for the action
        var icon_buttons = createIcons(action);
        var delete_button = icon_buttons[0];
        var edit_button = icon_buttons[1];
        action_div.appendChild(edit_button);
        action_div.appendChild(delete_button);
        // add to row
        row_action_div.appendChild(action_div);
        return [row_action_div, row_link_div];
    }

    // load initial planning
	function createPlanning(){

	    // load position select options for add action panel
	    loadAddActionSelect();

		//get whole frame
		var planning_frame = document.getElementById("planning");
		for(var act_idx in action_list){
			//alert(action); initial state, place brewer on cup...
			var action = action_list[act_idx];

            // create rows for action and link
            [row_action_div, row_link_div] = createRows(action);

			// add to frame
			planning_frame.appendChild(row_action_div);
			planning_frame.appendChild(row_link_div);
		}

		// add links and caps
		for(var pre_idx in precondition_list){
			var pre = precondition_list[pre_idx];
			var color = color_set[color_idx];
			var final_action = precondition_dict[pre][precondition_dict[pre].length - 1];
			var start_idx = action_list.indexOf(effect_list[pre]);
			var end_idx = action_list.indexOf(final_action);
			for(var j=0; j<action_list.length-1; j++){
                var new_svg = createSvg(action_list[j], pre);
				// before start_idx or after final_action, hide
				if(j>=start_idx && j<end_idx)
                    var new_link = createLink(color, hide=false);
				else
                    var new_link = createLink(color, hide=true);
				new_svg.appendChild(new_link);
				// create new cap and append to svg
				if(precondition_dict[pre].includes(action_list[j+1])){
					var new_cap = createCap(hide=false);
				}
				else{  // if just cross this action, hide the cap
                    var new_cap = createCap(hide=true);
				}
				new_svg.appendChild(new_cap);
				// add svg to document
				var link_row = document.getElementById(action_list[j]+"_link_row");
				link_row.append(new_svg);
			}
			color_idx++;
        }
	}

</script>
<script type="text/javascript" src="static/js/animation.js"></script>


</body>
</html>